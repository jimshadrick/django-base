{% extends "allauth/layouts/manage.html" %}
{% load allauth %}
{% load i18n %}

{% block head_title %}{% translate "Profile" %}{% endblock %}

{% block page_title_text %}{% translate "My Profile" %}{% endblock %}

{% block content %}
    <div class="row">
        <div class="card">
            <div class="card-body">
                <form method="post" novalidate>
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <label for="{{ form.first_name.id_for_label }}" class="form-label">
                            {% translate "First Name" %}
                        </label>
                        {{ form.first_name }}
                        {% if form.first_name.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.first_name.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.last_name.id_for_label }}" class="form-label">
                            {% translate "Last Name" %}
                        </label>
                        {{ form.last_name }}
                        {% if form.last_name.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.last_name.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.display_name.id_for_label }}" class="form-label">
                            {% translate "Display Name" %}
                        </label>
                        {{ form.display_name }}
                        <div class="form-text">{{ form.fields.display_name.help_text }}</div>
                        {% if form.display_name.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.display_name.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.email.id_for_label }}" class="form-label">
                            {% translate "Email" %}
                        </label>
                        {{ form.email }}
                        <div class="form-text">{{ form.email.help_text }}</div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary mt-2">
                        <i class="bi bi-save me-2"></i>{% translate "Save Changes" %}
                    </button>
                    
                    <!-- Delete Account Button -->
                    <a href="?partial=delete-account"
                       up-layer="new modal"
                       up-size="medium"
                       up-target="#delete-confirmation"
                       up-history="false"
                       class="btn btn-danger mt-2">
                        <i class="bi bi-trash me-2"></i>{% translate "Delete Account" %}
                    </a>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Delete Account modal (Django partial definition) -->
    {% partialdef delete-account %}
        <div id="delete-confirmation">
            <h5 class="text-danger mb-3">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>{% translate "Delete Account?" %}
            </h5>
            <div class="alert alert-warning mb-3">
                <p class="mb-2"><strong>{% translate "Warning:" %}</strong></p>
                <p class="mb-1">{% translate "By selecting confirm you will delete your account and any data you own." %}</p>
                <p class="mb-0">{% translate "This action cannot be undone." %}</p>
            </div>
            <form method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">
                    <i class="bi bi-trash me-2"></i>{% translate "Confirm" %}
                </button>
                <button type="button" class="btn btn-secondary" up-dismiss>
                    {% translate "Cancel" %}
                </button>
            </form>
        </div>
    {% endpartialdef %}
    
    <!-- Auto-update display_name based on first_name and last_name -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const firstNameInput = document.getElementById("id_first_name");
            const lastNameInput = document.getElementById("id_last_name");
            const displayNameInput = document.getElementById("id_display_name");

            if (!firstNameInput || !lastNameInput || !displayNameInput) {
                return; // fail silently if form changes
            }

            // Normalize names the same way Django's get_full_name() effectively does
            function buildFullName() {
                const first = firstNameInput.value.trim();
                const last = lastNameInput.value.trim();
                return [first, last].filter(Boolean).join(" ");
            }

            // Capture the initial state on page load
            const initialDisplayName = displayNameInput.value.trim();
            const initialFullName = buildFullName();

            // If display_name was already customized, we never auto-update
            let allowAutoUpdate =
                !initialDisplayName || initialDisplayName === initialFullName;

            function maybeUpdateDisplayName() {
                if (!allowAutoUpdate) return;

                const fullName = buildFullName();
                if (!fullName) return;

                displayNameInput.value = fullName;
            }

            // If the user types in display_name manually, lock it
            displayNameInput.addEventListener("input", function () {
                allowAutoUpdate = false;
            });

            // Update on blur (tabbing or clicking away)
            firstNameInput.addEventListener("blur", maybeUpdateDisplayName);
            lastNameInput.addEventListener("blur", maybeUpdateDisplayName);
        });
    </script>

{% endblock %}